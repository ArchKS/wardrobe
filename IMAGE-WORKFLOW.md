# 图片处理工作流程

## 新方案说明

为了优化性能和存储，所有图片现在都会转换为 WebP 格式，并压缩到 1MB 以下。文件名包含日期信息，避免丢失拍摄时间。

## 文件命名格式

```
原始名称_ID_日期.webp
例如：IMG_7891_a5c3d2_20251101.webp
```

- **原始名称**：保留原图片文件名（不含扩展名）
- **ID**：6位随机字符，确保文件唯一性
- **日期**：yyyyMMdd 格式，从原图片的内容创建时间提取

## 使用步骤

### 1. 添加新图片

将原始图片（HEIC/JPG/PNG 等）放入 `public/images` 目录

### 2. 转换为 WebP

运行转换命令：

```bash
npm run convert-webp
```

**转换过程：**
- ✅ 自动提取原图片的内容创建时间（macOS 使用 mdls 命令）
- ✅ 转换为 WebP 格式，质量自适应调整
- ✅ 压缩到 1MB 以下（如果需要会自动缩小尺寸）
- ✅ 重命名为：`原始名_id_yyyyMMdd.webp`
- ✅ 删除原始文件
- ✅ 显示进度条和转换统计

### 3. 同步到数据库

运行同步命令：

```bash
npm run sync
```

**同步过程：**
- ✅ 扫描 `public/images` 目录中的 `.webp` 文件
- ✅ 从文件名中提取日期（而不是读取文件元数据）
- ✅ 将新图片添加到 `wardrobe.json`
- ✅ 显示进度条和同步统计

### 4. 启动应用

```bash
npm run dev
```

应用会自动先运行 sync，然后启动开发服务器。

## 完整工作流程示例

```bash
# 1. 将照片复制到图片目录
cp ~/Photos/*.jpg public/images/

# 2. 转换为 WebP 格式
npm run convert-webp

# 输出示例：
# ╔════════════════════════════════════════╗
# ║   图片转换为 WebP 工具 v1.0          ║
# ╚════════════════════════════════════════╝
#
# 📁 找到 10 张图片需要转换
# 转换进度 |████████████████████| 100% | 10/10 张 | IMG_7891.JPG
#
# ╔════════════════════════════════════════╗
# ║            转换完成                    ║
# ╚════════════════════════════════════════╝
# ✅ 成功转换: 10 张

# 3. 同步到数据库
npm run sync

# 输出示例：
# ╔════════════════════════════════════════╗
# ║   衣橱图片同步工具 v1.0               ║
# ╚════════════════════════════════════════╝
#
# 📁 扫描图片目录...
#    找到 210 张图片
#    已记录 200 张图片
#    新增图片 10 张
#
# 📸 处理 10 张新图片...
# 添加进度 |████████████████████| 100% | 10/10 张 | IMG_7891_a5c3d2_20251101.webp
#
# ✅ 成功添加 10 个新项目到 wardrobe.json

# 4. 启动应用
npm run dev
```

## 性能优化

### WebP 格式优势
- 比 JPEG 小 25-35%
- 比 PNG 小 26-50%
- 支持有损和无损压缩
- 现代浏览器全面支持

### 懒加载
- 图片进入视口前 300px 开始加载
- 减少初始页面加载时间
- 优化大量图片场景下的性能

### 压缩策略
1. **质量调整**：从 90% 开始，逐步降低到 10%
2. **尺寸缩小**：如果质量调整后仍超过 1MB，自动缩小图片尺寸
3. **保持比例**：始终保持原始宽高比

## 注意事项

⚠️ **转换会删除原始文件**，请确保已有备份

⚠️ **文件名格式很重要**：如果文件名不符合 `*_*_yyyyMMdd.webp` 格式，同步时会使用文件系统时间

⚠️ **macOS 优势**：在 macOS 上使用 `mdls` 命令可以更准确地获取照片的拍摄时间

## 常用命令

| 命令 | 说明 |
|------|------|
| `npm run convert-webp` | 转换图片为 WebP 格式 |
| `npm run sync` | 同步图片到数据库 |
| `npm run dev` | 启动开发服务器（自动 sync） |
| `npm run build` | 构建生产版本（自动 sync） |
| `npm run clean` | 清理未使用的图片 |

## 故障排除

### 转换失败
- 检查图片文件是否损坏
- 确保有足够的磁盘空间
- macOS 用户确保有 `mdls` 命令权限

### 日期不正确
- 检查文件名格式是否为 `*_*_yyyyMMdd.webp`
- 如果原始图片没有 EXIF 数据，会使用文件系统时间

### 图片不显示
- 确保运行了 `npm run sync`
- 检查 `wardrobe.json` 中的图片路径
- 确保图片在 `public/images` 目录中
